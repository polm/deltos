// Generated by LiveScript 1.4.0
(function(){
  var child_process, Markdown, markdown, getAllEntries, ref$, map, sortBy, sortWith, reverse, readConfig, isIn, tagged, getFilename, getSlug, width, fs, blocks, getChildEntries, buildListPage, buildImageListPage, toMarkdownLink, toImageBlock, sortOrderThenDate, buildHierarchicalList, deltosLinkToHtml, processBlock, renderBlock, out$ = typeof exports != 'undefined' && exports || this;
  child_process = require('child_process');
  Markdown = require('markdown-it')({
    html: true
  });
  markdown = function(it){
    return Markdown.render(it);
  };
  getAllEntries = require('./entries').getAllEntries;
  ref$ = require('prelude-ls'), map = ref$.map, sortBy = ref$.sortBy, sortWith = ref$.sortWith, reverse = ref$.reverse;
  ref$ = require('./util'), readConfig = ref$.readConfig, isIn = ref$.isIn, tagged = ref$.tagged, getFilename = ref$.getFilename, getSlug = ref$.getSlug;
  width = readConfig().width || 500;
  fs = require('fs');
  blocks = {};
  blocks.img = function(block, entry){
    var words, imgSrc, tag, caption, ref$;
    words = block.split(' ');
    words.shift();
    imgSrc = words.shift();
    tag = "<img src=\"" + imgSrc + "\"/>";
    caption = words.length ? '<p class="caption">' + markdown(words.join(' ')).substr(3) : '';
    if (!entry.firstImage) {
      entry.firstImage = imgSrc;
      if ((ref$ = entry.firstImage.split('.'))[ref$.length - 2] === 'l') {
        entry.firstImage = entry.firstImage.split('.l.').join('.c.');
      }
    }
    return "<div class=\"img\">" + tag + caption + "</div>";
  };
  blocks.video = function(block, entry){
    var words, vidTag, caption;
    words = block.split(' ');
    words.shift();
    vidTag = "<video preload=\"auto\" autoplay=\"autoplay\" loop=\"loop\" style=\"width: 100%; height: auto;\" controls> <source src=\"" + words.shift() + "\" type='video/webm; codecs=\"vp8, vorbis\"'></source> </video>";
    caption = words.length ? '<p class="caption">' + words.join(' ') + '</p>' : '';
    return "<div class=\"img\">" + vidTag + caption + "</div>";
  };
  blocks.search = function(block, entry){
    return '<div class="search"><input class="deltos-search" type="text"></input><div class="deltos-results-summary"></div><div class="deltos-results"></div><script src="/search.js"></script></div>';
  };
  blocks.archive = function(block, entry){
    entry.updated = true;
    return buildImageListPage().join("\n");
  };
  blocks.children = function(block, entry){
    return buildListPage(getChildEntries(entry)).join("\n");
  };
  getChildEntries = function(parent){
    return getAllEntries().filter(function(it){
      var ref$;
      return -1 !== ((ref$ = parent.children) != null ? ref$.indexOf(it.id) : void 8);
    });
  };
  blocks.recent = function(block, entry){
    entry.updated = true;
    return buildImageListPage().slice(0, 5).join("\n");
  };
  buildListPage = function(entries, linker){
    linker == null && (linker = toMarkdownLink);
    if (!entries) {
      entries = getAllEntries();
    }
    entries = entries.filter(tagged('published')).filter(function(it){
      return !tagged('hidden', it);
    });
    return map(linker)(
    reverse(
    sortBy(function(it){
      return it.date;
    }, entries)));
  };
  buildImageListPage = function(entries){
    return buildListPage(entries, toImageBlock);
  };
  toMarkdownLink = function(it){
    var tags, day;
    tags = it.tags.filter(function(it){
      return it !== 'published';
    }).join(", ");
    day = it.date.substr(0, 10);
    return "- [" + it.title + "](/by-id/" + it.id + ".html#" + getSlug(it) + ") " + day + " <span class=\"tags\">" + tags + "</span>";
  };
  toImageBlock = function(it){
    var out;
    out = "<a href=\"/by-id/" + it.id + ".html\">";
    out += '<div class="img img-block">';
    if (it.firstImage) {
      out += "<img src=\"" + it.firstImage + "\">";
    }
    out += "<div class=\"text-overlay\">" + it.title + "</div>";
    out += "</div></a>";
    return out;
  };
  sortOrderThenDate = function(a, b){
    if ((a != null && a.order) && (b != null && b.order)) {
      if (a.order < b.order) {
        return 1;
      } else {
        return -1;
      }
    }
    if (a.date > b.date) {
      return -1;
    } else {
      return 1;
    }
  };
  buildHierarchicalList = function(entries, depth, parent){
    var children, out, spacer, i$, len$, child;
    parent == null && (parent = null);
    if (depth === 0) {
      return '';
    }
    if (parent) {
      children = entries.filter(function(it){
        return it.parents && isIn(it.parents, parent);
      });
    } else {
      children = entries.filter(function(it){
        return !it.parents;
      });
    }
    children = sortWith(sortOrderThenDate, children);
    out = '';
    spacer = parent ? '  ' : '';
    for (i$ = 0, len$ = children.length; i$ < len$; ++i$) {
      child = children[i$];
      out += spacer + toMarkdownLink(child) + "\n";
      if (depth > 0) {
        out += buildHierarchicalList(entries, depth - 1, child.id).split("\n").map(fn$).join('\n');
      }
    }
    return out;
    function fn$(it){
      return spacer + it;
    }
  };
  blocks.embed = function(block, entry){
    var lines, url, result, fname, rawFile;
    lines = block.split("\n");
    if (lines.length > 1) {
      return lines.slice(1).join('\n');
    }
    url = lines[0].split(' ').slice(1).join(' ');
    result = child_process.execSync("OEMBED_WIDTH=" + width + " kinkan '" + url + "'");
    fname = getFilename(entry.id);
    rawFile = fs.readFileSync(fname, 'utf-8');
    rawFile = rawFile.split(lines[0]).join(lines[0] + "\n" + result);
    fs.writeFileSync(fname, rawFile, 'utf-8');
    return result;
  };
  blocks.big = function(block, entry){
    var lines, out, i$, len$, line;
    lines = block.split('\n');
    lines.shift();
    out = '<div class="bigholder">';
    for (i$ = 0, len$ = lines.length; i$ < len$; ++i$) {
      line = lines[i$];
      out += '<span class="bigtext">' + line + '</span>';
    }
    out += '</div>';
    return out;
  };
  blocks['class'] = function(block, entry){
    var style, body, out;
    style = block.split("\n")[0].split(' ')[1];
    body = block.split("\n").slice(1).join("\n");
    return out = ("<p class=\"" + style + "\">") + markdown(deltosLinkToHtml(body)).slice(3);
  };
  deltosLinkToHtml = function(it){
    var linkRegex, entries;
    linkRegex = /\.\(([^\/]*)\/\/([^\)]*)\)/g;
    entries = getAllEntries();
    return it.replace(linkRegex, function(matched, label, dest){
      var entry;
      entry = entries.filter(function(it){
        return it.id === dest;
      })[0];
      return "<a href=\"/by-id/" + dest + ".html#" + getSlug(entry) + "\">" + label + "</a>";
    });
  };
  processBlock = function(keyword, block, entry){
    var e;
    try {
      return blocks[keyword](block, entry);
    } catch (e$) {
      e = e$;
      console.log("keyword: " + keyword);
      throw e;
    }
  };
  out$.renderBlock = renderBlock = function(block, entry){
    var keyword;
    while (block[0] === "\n") {
      block = block.substr(1);
    }
    if (block[0] === '!') {
      block = block.slice(1);
      keyword = block.split("\n")[0].split(' ')[0];
      return processBlock(keyword, block, entry);
    } else {
      return deltosLinkToHtml(block);
    }
  };
}).call(this);
